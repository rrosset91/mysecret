<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Secret</title>
    <script>
      async function deriveKey(secretKey) {
        const encoder = new TextEncoder();
        const keyMaterial = encoder.encode(secretKey);

        const hash = await crypto.subtle.digest("SHA-256", keyMaterial);

        return crypto.subtle.importKey("raw", hash, "AES-GCM", false, [
          "encrypt",
          "decrypt",
        ]);
      }

      async function encryptString(secretKey, text) {
        const key = await deriveKey(secretKey);
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encoder = new TextEncoder();
        const encrypted = await crypto.subtle.encrypt(
          { name: "AES-GCM", iv: iv },
          key,
          encoder.encode(text)
        );

        return btoa(
          String.fromCharCode(...iv) +
            String.fromCharCode(...new Uint8Array(encrypted))
        );
      }

      async function decryptString(secretKey, encryptedBase64) {
        const key = await deriveKey(secretKey);
        const encodedData = atob(encryptedBase64);
        const iv = crypto.getRandomValues(new Uint8Array(12));

        const iv = new Uint8Array(
          [...encodedData].slice(0, 12).map((char) => char.charCodeAt(0))
        );
        const data = new Uint8Array(
          [...encodedData].slice(12).map((char) => char.charCodeAt(0))
        );

        const decrypted = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv: iv },
          key,
          data
        );

        return new TextDecoder().decode(decrypted);
      }

      async function handleEncrypt() {
        const secretKey = document.getElementById("secret").value;
        const message = document.getElementById("message").value;
        if (!secretKey || !message) {
          alert("Fill in the secret and the message (input)");
          return;
        }
        const encrypted = await encryptString(secretKey, message);
        document.getElementById("output").value = encrypted;
      }

      async function handleDecrypt() {
        const secretKey = document.getElementById("secret").value;
        const encryptedMessage = document.getElementById("message").value;
        if (!secretKey || !encryptedMessage) {
          alert("Fill in the secret and the message (input)");
          return;
        }
        try {
          const decrypted = await decryptString(secretKey, encryptedMessage);
          document.getElementById("output").value = decrypted;
        } catch (error) {
          alert("Fail. Check the secret");
        }
      }
    </script>
  </head>
  <body>
    <h1>Encrypt & Decrypt</h1>
    <label for="secret">Secret:</label><br />
    <input type="password" id="secret" /><br /><br />
    <label for="message">Input/Message:</label><br />
    <textarea
      id="message"
      placeholder="Input (Encrypted or to Encrypt)"
    ></textarea
    ><br /><br />
    <button onclick="handleEncrypt()">Encrypt</button>
    <button onclick="handleDecrypt()">Decrypt</button><br /><br />
    <label for="output">Result:</label><br />
    <textarea id="output" readonly placeholder="Result goes here"></textarea>
  </body>
</html>
