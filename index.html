<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Encryptar e Descriptar</title>
    <script>
      async function deriveKey(secretKey) {
        const encoder = new TextEncoder();
        const keyMaterial = encoder.encode(secretKey);

        // Gerando uma chave válida com SHA-256 (256 bits)
        const hash = await crypto.subtle.digest("SHA-256", keyMaterial);

        return crypto.subtle.importKey("raw", hash, "AES-GCM", false, [
          "encrypt",
          "decrypt",
        ]);
      }

      async function encryptString(secretKey, text) {
        const key = await deriveKey(secretKey);
        const iv = crypto.getRandomValues(new Uint8Array(12)); // Vetor de inicialização (IV)
        const encoder = new TextEncoder();
        const encrypted = await crypto.subtle.encrypt(
          { name: "AES-GCM", iv: iv },
          key,
          encoder.encode(text)
        );

        // Concatenando IV e texto criptografado
        return btoa(
          String.fromCharCode(...iv) +
            String.fromCharCode(...new Uint8Array(encrypted))
        );
      }

      async function decryptString(secretKey, encryptedBase64) {
        const key = await deriveKey(secretKey);
        const encodedData = atob(encryptedBase64);

        // Separando IV e texto cifrado
        const iv = new Uint8Array(
          [...encodedData].slice(0, 12).map((char) => char.charCodeAt(0))
        );
        const data = new Uint8Array(
          [...encodedData].slice(12).map((char) => char.charCodeAt(0))
        );

        const decrypted = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv: iv },
          key,
          data
        );

        return new TextDecoder().decode(decrypted);
      }

      async function handleEncrypt() {
        const secretKey = document.getElementById("secret").value;
        const message = document.getElementById("message").value;
        if (!secretKey || !message) {
          alert("Por favor, preencha o segredo e a mensagem.");
          return;
        }
        const encrypted = await encryptString(secretKey, message);
        document.getElementById("output").value = encrypted;
      }

      async function handleDecrypt() {
        const secretKey = document.getElementById("secret").value;
        const encryptedMessage = document.getElementById("message").value;
        if (!secretKey || !encryptedMessage) {
          alert("Por favor, preencha o segredo e a mensagem criptografada.");
          return;
        }
        try {
          const decrypted = await decryptString(secretKey, encryptedMessage);
          document.getElementById("output").value = decrypted;
        } catch (error) {
          alert("Falha na descriptografia. Verifique o segredo ou a mensagem.");
        }
      }
    </script>
  </head>
  <body>
    <h1>Encryptar e Descriptar String</h1>
    <label for="secret">Segredo:</label><br />
    <input type="text" id="secret" placeholder="Digite o segredo" /><br /><br />
    <label for="message">Mensagem:</label><br />
    <textarea
      id="message"
      placeholder="Digite a mensagem ou mensagem criptografada"
    ></textarea
    ><br /><br />
    <button onclick="handleEncrypt()">Encryptar</button>
    <button onclick="handleDecrypt()">Descriptar</button><br /><br />
    <label for="output">Resultado:</label><br />
    <textarea
      id="output"
      readonly
      placeholder="O resultado aparecerá aqui"
    ></textarea>
  </body>
</html>
